name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches:
      - main

env:
  DOCKER_IMAGE_NAME: cats-dogs-classifier
  KUBERNETES_NAMESPACE: default

jobs:
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Configure kubectl context
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config
          kubectl config current-context
          kubectl cluster-info

      - name: Update deployment image
        run: |
          # Update image tag in deployment
          export DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
          export IMAGE_TAG=${{ github.sha }}

          # Replace placeholders in deployment files
          sed -i "s|\${DOCKER_USERNAME}|$DOCKER_USERNAME|g" deployment/kubernetes/deployment.yaml
          sed -i "s|:latest|:main-sha-${IMAGE_TAG:0:7}|g" deployment/kubernetes/deployment.yaml

          cat deployment/kubernetes/deployment.yaml

      - name: Apply Kubernetes manifests
        run: |
          kubectl apply -f deployment/kubernetes/deployment.yaml
          kubectl apply -f deployment/kubernetes/service.yaml

      - name: Wait for rollout to complete
        run: |
          kubectl rollout status deployment/cats-dogs-classifier -n ${{ env.KUBERNETES_NAMESPACE }} --timeout=5m

      - name: Get deployment status
        run: |
          echo "Deployment status:"
          kubectl get deployment cats-dogs-classifier -n ${{ env.KUBERNETES_NAMESPACE }}
          echo ""
          echo "Pods:"
          kubectl get pods -l app=cats-dogs-classifier -n ${{ env.KUBERNETES_NAMESPACE }}
          echo ""
          echo "Service:"
          kubectl get service cats-dogs-classifier -n ${{ env.KUBERNETES_NAMESPACE }}

      - name: Get service endpoint
        id: endpoint
        run: |
          # Wait for LoadBalancer IP
          for i in {1..30}; do
            EXTERNAL_IP=$(kubectl get service cats-dogs-classifier -n ${{ env.KUBERNETES_NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
            if [ -n "$EXTERNAL_IP" ]; then
              echo "Service endpoint: http://$EXTERNAL_IP:8000"
              echo "endpoint=http://$EXTERNAL_IP:8000" >> $GITHUB_OUTPUT
              break
            fi
            echo "Waiting for LoadBalancer IP... (attempt $i/30)"
            sleep 10
          done

          # If no external IP, try minikube service URL
          if [ -z "$EXTERNAL_IP" ]; then
            echo "No external IP found. If using minikube, use: minikube service cats-dogs-classifier --url"
            echo "endpoint=http://localhost:8000" >> $GITHUB_OUTPUT
          fi

      - name: Install Python dependencies for smoke tests
        run: |
          python -m pip install --upgrade pip
          pip install requests pillow

      - name: Run smoke tests
        env:
          API_URL: ${{ steps.endpoint.outputs.endpoint }}
        run: |
          python scripts/smoke_test.py --url ${API_URL} --timeout 60

      - name: Deployment summary
        if: success()
        run: |
          echo "üöÄ Deployment successful!"
          echo ""
          echo "Deployment details:"
          echo "  - Image: ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:main-sha-${{ github.sha }}"
          echo "  - Namespace: ${{ env.KUBERNETES_NAMESPACE }}"
          echo "  - Endpoint: ${{ steps.endpoint.outputs.endpoint }}"
          echo ""
          echo "All smoke tests passed ‚úÖ"

      - name: Rollback on failure
        if: failure()
        run: |
          echo "‚ùå Deployment or smoke tests failed. Rolling back..."
          kubectl rollout undo deployment/cats-dogs-classifier -n ${{ env.KUBERNETES_NAMESPACE }}
          kubectl rollout status deployment/cats-dogs-classifier -n ${{ env.KUBERNETES_NAMESPACE }}

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [deploy]
    if: failure()

    steps:
      - name: Deployment failed
        run: |
          echo "‚ùå CD Pipeline failed!"
          echo "Please check the logs and deployment status."
          exit 1
